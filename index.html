<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pikmin è˜‘è‡çµ„éšŠç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }</style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="max-w-lg mx-auto min-h-screen bg-white shadow-xl relative pb-20">
        <header class="bg-emerald-600 text-white p-4 sticky top-0 z-10 flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold flex items-center gap-2">ğŸ„ è˜‘è‡çµ„éšŠç«™</h1>
            <button id="auth-btn" onclick="toggleAuth()" class="text-xs bg-emerald-700 px-3 py-1 rounded-full border border-emerald-500">ç™»å…¥</button>
        </header>

        <div id="login-view" class="p-8 text-center hidden">
            <div class="text-6xl mb-4">ğŸ‘‹</div>
            <h2 class="text-xl font-bold mb-2">æ­¡è¿åŠ å…¥çµ„éšŠ</h2>
            <p class="text-gray-500 mb-6">è«‹å…ˆç™»å…¥ä»¥é–‹å§‹å¾µæ±‚æˆ–åŠ å…¥éšŠä¼</p>
            <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg active:scale-95 transition">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
        </div>

        <div id="main-view" class="hidden p-4 space-y-6">
            
            <div id="profile-setup" class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-sm hidden">
                <p>ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ<span id="display-name" class="font-bold"></span></p>
            </div>

            <div class="bg-white border-2 border-emerald-100 rounded-xl p-4 shadow-sm">
                <h3 class="font-bold text-emerald-800 mb-3 flex items-center">ğŸ“¢ ç™¼èµ·æ–°çš„å¾µæ±‚</h3>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <select id="m-type" class="bg-gray-50 border rounded p-2 text-sm">
                        <option value="ä¸€èˆ¬è˜‘è‡">ğŸ”´ ä¸€èˆ¬è˜‘è‡</option>
                        <option value="å·¨å¤§è˜‘è‡">ğŸ”¥ å·¨å¤§è˜‘è‡</option>
                        <option value="ç‰¹æ®Šè˜‘è‡">âœ¨ ç‰¹æ®Š/å…ƒç´ </option>
                    </select>
                    <select id="m-max" class="bg-gray-50 border rounded p-2 text-sm">
                        <option value="4">ç¼º 4 äºº</option>
                        <option value="3">ç¼º 3 äºº</option>
                        <option value="2">ç¼º 2 äºº</option>
                        <option value="1">ç¼º 1 äºº</option>
                    </select>
                </div>
                <input id="m-code" type="tel" placeholder="è¼¸å…¥å¥½å‹ä»£ç¢¼ (12ä½æ•¸å­—)" class="w-full bg-gray-50 border rounded p-2 mb-3 text-center tracking-widest font-mono">
                <button onclick="createPost()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 rounded-lg transition shadow">ç™¼å¸ƒå¾µæ±‚ (è‡ªå‹•è¨˜æ†¶ä»£ç¢¼)</button>
            </div>

            <div>
                <h3 class="font-bold text-gray-700 mb-3 border-l-4 border-orange-400 pl-2">ğŸ”¥ å³æ™‚éšŠä¼åˆ—è¡¨</h3>
                <div id="posts-container" class="space-y-4 pb-10">
                    <p class="text-center text-gray-400 py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. åˆå§‹åŒ– (è«‹åœ¨æ­¤å¡«å…¥ä½ çš„ Firebase Config) ---
const firebaseConfig = {
  apiKey: "AIzaSyC56QsHKnTuwHFNAwQ2hywBuUviu12wtb4",
  authDomain: "chiangku-240a5.firebaseapp.com",
  databaseURL: "https://chiangku-240a5-default-rtdb.firebaseio.com",
  projectId: "chiangku-240a5",
  storageBucket: "chiangku-240a5.firebasestorage.app",
  messagingSenderId: "96178563604",
  appId: "1:96178563604:web:7d44030277f9b665219501",
  measurementId: "G-1M37BGXY44"
};

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;

        // --- 2. ç™»å…¥èˆ‡ç‹€æ…‹ç›£è½ ---
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function toggleAuth() { if(currentUser) auth.signOut(); else login(); }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('auth-btn').innerText = "ç™»å‡º";
                document.getElementById('display-name').innerText = user.displayName;
                
                // è‡ªå‹•è®€å–è¨˜æ†¶ä»£ç¢¼
                db.ref(`users/${user.uid}/friendCode`).once('value', s => {
                    if(s.exists()) document.getElementById('m-code').value = s.val();
                });
                
                loadPosts(); // å•Ÿå‹•ç›£è½
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('main-view').classList.add('hidden');
                document.getElementById('auth-btn').innerText = "ç™»å…¥";
            }
        });

        // --- 3. ç™¼æ–‡åŠŸèƒ½ (å«è‡ªå‹•è¨˜æ†¶) ---
        async function createPost() {
            const type = document.getElementById('m-type').value;
            const max = parseInt(document.getElementById('m-max').value);
            const code = document.getElementById('m-code').value.replace(/\D/g, ''); // åªç•™æ•¸å­—

            if (code.length < 12) return alert("å¥½å‹ä»£ç¢¼éœ€ç‚º 12 ä½æ•¸å­—");

            const newPostKey = db.ref('posts').push().key;

            // åŒæ­¥å¯«å…¥ä¸‰è™•ï¼šå…¬é–‹è²¼æ–‡ã€ç§å¯†ä»£ç¢¼ã€å€‹äººè¨˜æ†¶
            const updates = {};
            updates[`/posts/${newPostKey}`] = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                type: type,
                max: max,
                current: 0,
                time: firebase.database.ServerValue.TIMESTAMP
            };
            updates[`/private_data/${newPostKey}`] = { friendCode: code };
            updates[`/users/${currentUser.uid}/friendCode`] = code; // è¨˜æ†¶ä»£ç¢¼

            try {
                await db.ref().update(updates);
                alert("ç™¼å¸ƒæˆåŠŸï¼ç­‰å¾…ç©å®¶åŠ å…¥...");
            } catch (e) {
                alert("ç™¼å¸ƒå¤±æ•—ï¼š" + e.message);
            }
        }

        // --- 4. åˆ—è¡¨æ¸²æŸ“èˆ‡äº’å‹•é‚è¼¯ ---
        function loadPosts() {
            // åªé¡¯ç¤ºæœ€è¿‘ 20 ç­†
            db.ref('posts').limitToLast(20).on('value', snapshot => {
                const container = document.getElementById('posts-container');
                container.innerHTML = '';
                
                const posts = [];
                snapshot.forEach(child => posts.push({key: child.key, ...child.val()}));
                posts.reverse(); // æ–°çš„åœ¨ä¸Šé¢

                posts.forEach(post => {
                    const isHost = post.uid === currentUser.uid;
                    const timeStr = new Date(post.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let html = `
                    <div class="bg-white border rounded-xl p-4 shadow-sm relative overflow-hidden">
                        ${post.current >= post.max ? '<div class="absolute top-0 right-0 bg-red-500 text-white text-xs px-2 py-1">é¡æ»¿</div>' : ''}
                        
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-bold">${post.type}</span>
                                <h4 class="font-bold text-lg mt-1">${post.name}</h4>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-emerald-500">${post.current}/${post.max}</div>
                                <div class="text-xs text-gray-400">${timeStr}</div>
                            </div>
                        </div>

                        <div id="action-area-${post.key}" class="mt-3 pt-3 border-t border-gray-100">
                            </div>
                    </div>`;

                    container.insertAdjacentHTML('beforeend', html);
                    
                    if (isHost) renderHostControls(post.key, post);
                    else renderGuestControls(post.key, post);
                });
            });
        }

        // --- A. ç™¼æ–‡è€…è¦–è§’ï¼šå¯©æ ¸åå–® ---
        function renderHostControls(postId, post) {
            const area = document.getElementById(`action-area-${postId}`);
            area.innerHTML = `<p class="text-xs text-gray-400 mb-2">å¾…å¯©æ ¸åå–®ï¼š</p><div id="apps-${postId}" class="space-y-2"></div>`;
            
            db.ref(`applications/${postId}`).on('value', snap => {
                const appDiv = document.getElementById(`apps-${postId}`);
                appDiv.innerHTML = '';
                if(!snap.exists()) appDiv.innerHTML = '<p class="text-xs text-gray-300">å°šç„¡äººç”³è«‹</p>';

                snap.forEach(s => {
                    const app = s.val();
                    if(app.status === 'accepted') return; // å·²æ¥å—çš„ä¸é¡¯ç¤º

                    const btn = `<button onclick="acceptUser('${postId}', '${s.key}', ${post.current}, ${post.max})" class="bg-blue-500 text-white text-xs px-3 py-1 rounded">æ¥å—</button>`;
                    appDiv.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm"><span>${app.name}</span>${btn}</div>`;
                });
            });
        }

        // --- B. ç”³è«‹è€…è¦–è§’ï¼šç”³è«‹ / çœ‹ä»£ç¢¼ ---
        function renderGuestControls(postId, post) {
            const area = document.getElementById(`action-area-${postId}`);
            
            db.ref(`applications/${postId}/${currentUser.uid}`).on('value', snap => {
                const myApp = snap.val();
                
                if (!myApp) {
                    // å°šæœªç”³è«‹
                    if (post.current >= post.max) {
                        area.innerHTML = `<button disabled class="w-full bg-gray-100 text-gray-400 py-2 rounded">å·²é¡æ»¿</button>`;
                    } else {
                        area.innerHTML = `<button onclick="applyJoin('${postId}')" class="w-full bg-emerald-100 text-emerald-700 font-bold py-2 rounded hover:bg-emerald-200">ğŸ™‹â€â™‚ï¸ ç”³è«‹åŠ å…¥</button>`;
                    }
                } else if (myApp.status === 'pending') {
                    // ç­‰å¾…ä¸­
                    area.innerHTML = `<button disabled class="w-full bg-yellow-50 text-yellow-600 py-2 rounded border border-yellow-200">â³ ç­‰å¾…æˆ¿ä¸»å¯©æ ¸ä¸­...</button>`;
                } else if (myApp.status === 'accepted') {
                    // å·²æ ¸å‡† -> æŠ“ç¾ä»£ç¢¼
                    db.ref(`private_data/${postId}/friendCode`).once('value', s => {
                        const code = s.val();
                        area.innerHTML = `
                        <div class="bg-green-50 p-3 rounded border border-green-200 text-center">
                            <p class="text-xs text-green-600 mb-1">å·²æ ¸å‡†ï¼è«‹è¤‡è£½ä»£ç¢¼ï¼š</p>
                            <div class="text-xl font-mono font-bold text-gray-800 select-all" onclick="copy('${code}')">${code}</div>
                            <p class="text-[10px] text-gray-400 mt-1">(é»æ“Šä»£ç¢¼è¤‡è£½)</p>
                        </div>`;
                    });
                }
            });
        }

        // --- 5. äº’å‹•åŠŸèƒ½å‡½æ•¸ ---
        function applyJoin(postId) {
            db.ref(`applications/${postId}/${currentUser.uid}`).set({
                name: currentUser.displayName,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function acceptUser(postId, guestUid, current, max) {
            if(current >= max) return alert("äººæ•¸å·²æ»¿");
            
            // äº¤æ˜“æ›´æ–°ï¼šåŒæ™‚æ›´æ–°ç”³è«‹ç‹€æ…‹èˆ‡ç›®å‰äººæ•¸
            const updates = {};
            updates[`applications/${postId}/${guestUid}/status`] = 'accepted';
            updates[`posts/${postId}/current`] = current + 1;
            
            db.ref().update(updates);
        }

        function copy(text) {
            navigator.clipboard.writeText(text).then(() => alert("ä»£ç¢¼å·²è¤‡è£½ï¼"));
        }
    </script>
</body>
</html>